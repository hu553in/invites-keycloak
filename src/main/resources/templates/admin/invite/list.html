<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Invites</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f7fb;
            margin: 0;
            padding: 0;
            color: #1f2933;
        }

        header {
            background-color: #111827;
            color: #fff;
            padding: 1.5rem;
        }

        main {
            padding: 2rem;
        }

        .actions {
            margin-bottom: 1rem;
        }

        .actions a {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            text-decoration: none;
            background-color: #2563eb;
            color: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 0.5rem 1.5rem rgba(15, 23, 42, 0.08);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        thead {
            background-color: #e0e7ff;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .status {
            padding: 0.125rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status.active {
            background-color: #dcfce7;
            color: #166534;
        }

        .status.revoked {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status.expired {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status.used-up {
            background-color: #e5e7eb;
            color: #374151;
        }

        .actions-inline {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .actions-inline form {
            margin: 0;
        }

        button.action {
            padding: 0.35rem 0.75rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            background-color: #f3f4f6;
        }

        button.action.primary {
            background-color: #2563eb;
            color: #fff;
        }

        button.action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .expiry-field {
            display: flex;
            flex-direction: column;
            font-size: 0.75rem;
        }

        .expiry-field input {
            margin-top: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #cbd5f5;
            width: 6rem;
        }

        .invite-link {
            margin: 1rem 0;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            background-color: #ecfccb;
            color: #365314;
        }

        code {
            background-color: #111827;
            color: #fff;
            padding: 0.15rem 0.35rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
        }

        .alert {
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
        }

        .alert.success {
            background-color: #dcfce7;
            color: #166534;
        }

        .alert.error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .alert.info {
            background-color: #e0f2fe;
            color: #0f172a;
        }

        .alert.warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        .empty {
            padding: 1rem;
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 0.25rem 1rem rgba(15, 23, 42, 0.05);
        }
    </style>
</head>
<body>
<header>
    <h1>Invite administration</h1>
</header>
<main>
    <div th:if="${successMessage}" class="alert success" th:text="${successMessage}">Success</div>
    <div th:if="${errorMessage}" class="alert error" th:text="${errorMessage}">Error</div>
    <div th:if="${mailStatusMessage}"
         th:class="'alert ' + (${mailStatusLevel} ?: 'info')"
         th:text="${mailStatusMessage}">
        Email status
    </div>
    <div class="alert info">
        Status legend:
        <strong>Active</strong> — usable invite;
        <strong>Used up</strong> — max uses reached (retry requires new invite);
        <strong>Expired</strong> — past expiry (issue a new one);
        <strong>Revoked</strong> — manually revoked or failed due to non-recoverable Keycloak error.
    </div>
    <div th:if="${inviteLink}" class="invite-link">
        Invite link:
        <code th:text="${inviteLink}">https://example.org/invite/realm/token</code>
    </div>

    <div class="actions">
        <a th:href="@{/admin/invite/new}">Create invite</a>
    </div>

    <div th:if="${#lists.isEmpty(invites)}" class="empty">
        No invites yet. Create one to get started.
    </div>

    <table th:if="${!#lists.isEmpty(invites)}">
        <thead>
        <tr>
            <th>ID</th>
            <th>Created</th>
            <th>Email</th>
            <th>Realm</th>
            <th>Expires</th>
            <th>Uses</th>
            <th>Status</th>
            <th>Roles</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="invite : ${invites}">
            <td><code th:text="${invite.id}">id</code></td>
            <td th:text="${#temporals.format(invite.createdAt, 'yyyy-MM-dd HH:mm:ss z')}">2025-01-01 12:00:00 UTC</td>
            <td th:text="${invite.email}">user@example.com</td>
            <td th:text="${invite.realm}">master</td>
            <td th:text="${#temporals.format(invite.expiresAt, 'yyyy-MM-dd HH:mm:ss z')}">2025-01-02 12:00:00 UTC</td>
            <td th:text="|${invite.uses} / ${invite.maxUses}|">0 / 1</td>
            <td>
                <span th:class="'status ' + ${invite.statusClass}"
                      th:text="${invite.statusLabel}">
                    Active
                </span>
            </td>
            <td th:text="${#strings.listJoin(invite.roles, ', ')}">realm-role</td>
            <td>
                <div class="actions-inline">
                    <form th:action="@{|/admin/invite/${invite.id}/revoke|}" method="post">
                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}"
                               th:value="${_csrf.token}"/>
                        <button class="action" type="submit" th:disabled="${invite.revoked}">
                            Revoke
                        </button>
                    </form>
                    <form th:action="@{|/admin/invite/${invite.id}/resend|}" method="post">
                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}"
                               th:value="${_csrf.token}"/>
                        <label class="expiry-field">
                            <span>Expiry (min)</span>
                            <input type="number"
                                   name="expiryMinutes"
                                   th:value="${expiryDefaultMinutes}"
                                   th:attr="min=${expiryMinMinutes},max=${expiryMaxMinutes},step=5"/>
                        </label>
                        <button class="action primary" type="submit" th:disabled="${invite.statusClass != 'active'}">
                            Resend
                        </button>
                    </form>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
</main>
</body>
</html>
